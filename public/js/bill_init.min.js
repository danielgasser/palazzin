$.fn.dataTable.ext.order["dom-text"]=function(a,b){return this.api().column(b,{order:"index"}).nodes().map(function(a){return $("#"+a.id).children("input").val()})};var billTable,dataTableSettings={dataSrc:"",stripeClasses:["odd","even"],responsive:!1,autoWidth:!0,fixedHeader:{header:!0,footer:!0},language:{emptyTable:"Keine Rechungen vorhanden",paginate:{first:window.paginationLang.first,previous:window.paginationLang.previous,next:window.paginationLang.next,last:window.paginationLang.last},search:window.langDialog.search,info:window.paginationLang.info,sLengthMenu:window.paginationLang.length_menu},order:[1,"asc"],paging:!1,columnDefs:[{targets:[0],responsivePriority:1,class:"details",visible:!0,orderable:!1,data:null,defaultContent:""},{targets:[1],responsivePriority:1,data:"bill_no"},{targets:[2],responsivePriority:2,visible:!0,orderable:!0,data:"bill_bill_date",render:function(a,b){if("sort"===b){let b=a.split("."),c=new Date(b[2],b[1],b[0],0,0,0);return c.getTime()}return a}},{targets:[3],responsivePriority:2,visible:!0,orderable:!0,data:"bill_total",type:"numeric-comma",render:function(a,b){if("sort"===b){let b=a.split(" ");return parseFloat(b[1])}return a}},{targets:[4],responsivePriority:3,visible:!0,orderable:!0,sortable:!0,data:"user_first_name user_name",type:"string",render:function(a,b){return"sort"===b?$(a).html():a}},{targets:[5],responsivePriority:4,visible:!0,orderable:!1,data:"bill_due"},{targets:[6],responsivePriority:5,orderable:!0,data:"bill_paid",render:function(a,b){let c=$("#"+a.split(" ")[7].split("\"")[1]).val();if("sort"===b){let a=c.split("."),b=new Date(a[2],a[1],a[0],0,0,0);return b.getTime()}return a}},{targets:[7],responsivePriority:6,visible:!0,orderable:!1,data:"bill_path"},{targets:[8],responsivePriority:7,visible:!0,orderable:!1},{targets:[9],responsivePriority:8,visible:!0,orderable:!0,data:"bill_resent_date",render:function(a,b){if("sort"===b){let b=a.split("."),c=new Date(b[2],b[1],b[0],0,0,0);return c.getTime()}return a}}],initComplete:function(){this.api().columns(5).every(function(){var a=this,b=$("<select class=\"form-control input-sm show_reservation\"><option value=\"\"></option></select>").appendTo($(a.header()).empty()).on("change",function(){var b=$.fn.dataTable.util.escapeRegex($(this).val());a.search(b?"^"+b+"$":"",!0,!1).draw(),datePickerInit()});a.data().unique().sort().each(function(a){b.append("<option value=\""+a+"\">"+a+"</option>")})})}},datePickerSettings={format:"dd.mm.yyyy",weekStart:1,todayBtn:"linked",clearBtn:!0,language:"de",calendarWeeks:!0,autoclose:!0,todayHighlight:!0,immediateUpdates:!0},datePickers=[],datePickerInit=function(){$.each($("[id^=\"paidAt_\"]"),function(a,b){let c=$(b).attr("id");datePickers.push({[c]:$(b).datepicker(datePickerSettings)}),$(b).datepicker("setDate",new Date($(b).parent("td").attr("data-sort"))).on("hide",function(a){payBill(a,$(b).val())})})},deFormatDate=function(a,b){let c=a.split(b),d=[],e=parseInt(c[1],10),f=parseInt(c[0],10);return d[2]=10>f?"0"+f:f,d[1]=10>e?"0"+e:e,d[0]=c[2],d.join("-")},payBill=function(a,b){var c,d,e=a.target.id.split("_")[1];""===b?(c="unpaid",d=window.billPaid[0]):(c="paid",b=deFormatDate(b,"."),d=window.billPaid[1]),a.preventDefault(),$.ajax({type:"GET",url:"/admin/bills/"+c,data:{id:e,bill_paid:b,paid_at:$("#paidAt_"+e).val()},success:function(a){GlobalFunctions.unAuthorized(a);let b=$("#paidAt_"+e);return $("#paid_"+e).html(d),b.val(a.paid),null===a.paid?$("#re_send_"+e).html("<button class=\"btn btn-default\" id=\"bill_sent_"+e+"\">"+window.langBill+"</button>"):$("#bill_sent_"+e).remove(),$("#year").trigger("change"),!1}})},resendBill=function(a){$.ajax({type:"POST",url:"/admin/send_bill",data:{id:a},success:function(b){return GlobalFunctions.unAuthorized(b),$("#re_sent_"+a).html(b.resent).attr("data-sort",b.resent_data_sort),!1}})},getBillTotals=function(a){let b="all"===a?"/admin/bills/totals":"/stats_bill_total_year";$.ajax({type:"GET",url:b,data:{year:a,user_id:-1<window.route.indexOf("user/bills")},success:function(b){let c=b.hasOwnProperty("unpaid")?b.unpaid[a]:"-",d=b.hasOwnProperty("paid")?b.paid[a]:"-",e=b.hasOwnProperty("total")?b.total[a]:"-";"all"===a&&(c=b.unpaid,d=b.paid,e=b.total),$("#paid").html("CHF "+d),$("#total").html("CHF "+e),$("#unpaid").html("CHF "+c)}})};$(document).ready(function(){billTable=$("#bills").DataTable(dataTableSettings),datePickerInit()}),$(document).on("click",".paginate_button>a",function(){datePickerInit()}),$(document).on("click","[id^=\"bill_sent_\"]",function(){let a=$(this).attr("id").split("_")[2];resendBill(a)}),$(document).on("change","#year",function(){getBillTotals(this.value)});